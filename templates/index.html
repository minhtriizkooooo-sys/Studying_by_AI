<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI QUIZ MARIE CURIE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --navy: #001f3f; --orange: #FF4500; --gold: #FFD700; }
        body { background: #f4f6f9; min-height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; }
        
        header { background: var(--navy); color: white; padding: 8px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .sub-header { background: #fff; color: var(--navy); text-align: center; padding: 6px; font-weight: bold; border-bottom: 3px solid var(--gold); font-size: 0.9rem; }

        footer { background: var(--navy); color: white; padding: 15px; text-align: center; margin-top: auto; border-top: none; }
        .ft-orange { color: var(--orange); font-weight: bold; }

        .main-card { background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 1.5rem; margin-bottom: 20px; }
        .timer-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .timer-bar { height: 100%; background: linear-gradient(to right, #28a745, #dc3545); width: 100%; transition: width 0.1s linear; }
        
        .btn-ans { border: 2px solid #e9ecef; background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 8px; width: 100%; text-align: left; transition: 0.2s; }
        .btn-ans:hover:not(:disabled) { border-color: var(--navy); background: #f8fbff; }
        .hidden { display: none !important; }
        .wait-box { border: 1px solid #ddd; border-radius: 5px; max-height: 180px; overflow-y: auto; padding: 10px; background: #fdfdfd; }
        .player-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee; }

        /* Template Table */
        .tmpl-table { font-size: 11px; background: #fff; border: 1px solid #ccc; width: 100%; }
        .tmpl-table th { background: #eee; border: 1px solid #ccc; padding: 2px; }
        .tmpl-table td { border: 1px solid #ccc; padding: 2px; }
    </style>
</head>
<body>

<header class="d-flex justify-content-between align-items-center">
    <img src="/static/images/Logo_Marie_Curie.png" alt="Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/826/826070.png'">
    <h6 class="m-0 fw-bold">MARIE CURIE EDUCATION</h6>    
</header>
<div class="sub-header">HỆ THỐNG TRẮC NGHIỆM AI - MARIE CURIE</div>

<div id="toast-container" style="position:fixed; top:80px; left:50%; transform:translateX(-50%); z-index:9999;"></div>

<main class="container my-4">
    <div id="start-screen" class="text-center py-5">
        <div class="main-card d-inline-block p-5">
            <h4 class="mb-4">Chọn vai trò của bạn</h4>
            <button class="btn btn-dark btn-lg px-4 mx-2" onclick="showHost()">GIÁO VIÊN</button>
            <button class="btn btn-outline-dark btn-lg px-4 mx-2" onclick="showUser()">THÍ SINH</button>
        </div>
    </div>

    <div id="host-panel" class="hidden">
        <div class="row">
            <div class="col-md-5">
                <div class="main-card">
                    <h6 class="fw-bold text-primary">1. Tải bộ đề (Excel/CSV)</h6>
                    <p class="small text-muted mb-2">Đúng biểu mẫu như bảng dưới:</p>
                    <table class="tmpl-table mb-3">
                        <tr><th>Câu hỏi</th><th>Đáp án A</th><th>Đáp án B</th><th>Đáp án C</th><th>Đáp án D</th><th>Đáp án đúng</th><th>Giải thích</th></tr>
                        <tr><td>Nội dung...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>A (hoặc B,C,D)</td><td>...</td></tr>
                    </table>
                    <input type="file" id="file-in" class="form-control mb-3">
                    <div id="qr-display" class="hidden text-center p-3 border rounded bg-light">
                        <img id="qr-img" style="width:140px;">
                        <h2 class="fw-bold text-primary mt-2" id="pin-txt"></h2>
                    </div>
                </div>
                <div class="main-card">
                    <h6 class="fw-bold">2. Danh sách chờ duyệt</h6>
                    <button class="btn btn-sm btn-success w-100 mb-2 hidden" id="btn-app-all" onclick="socket.emit('approve_all')">Duyệt tất cả thí sinh</button>
                    <div id="wait-list" class="wait-box"></div>
                </div>
                <button class="btn btn-danger btn-lg w-100 mb-2 hidden" id="btn-start" onclick="socket.emit('start_round')">BẮT ĐẦU VÒNG THI</button>
            </div>
            <div class="col-md-7">
                <div class="main-card">
                    <h6 class="text-center border-bottom pb-2">THEO DÕI TRỰC TIẾP</h6>
                    <div id="host-monitor" class="py-4 text-center h5">Chưa bắt đầu thi</div>
                    <hr>
                    <h6 class="fw-bold">BẢNG XẾP HẠNG</h6>
                    <div id="h-lb"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-panel" class="hidden">
        <div id="user-login" class="main-card mx-auto" style="max-width: 380px;">
            <input type="text" id="u-name" class="form-control mb-2" placeholder="Nhập Họ và Tên">
            <input type="text" id="u-pin" class="form-control mb-3" placeholder="Nhập Mã PIN">
            <button class="btn btn-primary w-100" onclick="joinRoom()">GỬI YÊU CẦU VÀO PHÒNG</button>
        </div>
        <div id="user-active" class="hidden">
            <div class="main-card text-center">
                <div id="u-info" class="small text-muted mb-2"></div>
                <h4 id="u-q-text" class="fw-bold my-4">Đang chờ câu hỏi...</h4>
                <div class="timer-bg mb-4"><div id="u-t-bar" class="timer-bar"></div></div>
                <div id="u-ans-box"></div>
            </div>
            <div class="main-card">
                <h6>XẾP HẠNG CỦA BẠN</h6>
                <div id="u-lb"></div>
            </div>
        </div>
    </div>

    <div id="review-panel" class="hidden main-card">
        <h4 class="text-primary border-bottom pb-2">REVIEW KẾT QUẢ & GIẢI THÍCH</h4>
        <div id="review-data" class="mt-3"></div>
        <button class="btn btn-dark w-100 mt-3" onclick="location.reload()">Quay lại màn hình chính</button>
    </div>
</main>

<footer>
    Developer: <span class="ft-orange">Lại Nguyễn Minh Trí</span> | Hotline: <span class="ft-orange">84-908-08-3566</span><br>
    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px;">Hệ thống Trắc nghiệm Thông minh © 2026</div>
</footer>

<script>
    const socket = io();
    let role = "";
    let qTimer;

    function showHost() { role="host"; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('host-panel').classList.remove('hidden'); }
    function showUser() { role="user"; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('user-panel').classList.remove('hidden'); }

    document.getElementById('file-in').onchange = e => {
        const r = new FileReader();
        r.onload = () => socket.emit('host_upload_file', {content: r.result});
        r.readAsDataURL(e.target.files[0]);
    };

    socket.on('qr_ready', d => {
        document.getElementById('qr-display').classList.remove('hidden');
        document.getElementById('qr-img').src = "data:image/png;base64," + d.qr;
        document.getElementById('pin-txt').innerText = d.pin;
        document.getElementById('btn-start').classList.remove('hidden');
        document.getElementById('btn-app-all').classList.remove('hidden');
    });

    socket.on('new_player_waiting', d => {
        const row = document.createElement('div');
        row.className = "player-row";
        row.innerHTML = `<span>${d.name}</span> <button class="btn btn-xs btn-primary py-0" onclick="socket.emit('approve_player', {sid:'${d.sid}'})">Duyệt</button>`;
        document.getElementById('wait-list').appendChild(row);
    });

    function joinRoom() {
        socket.emit('join_request', {name: document.getElementById('u-name').value, pin: document.getElementById('u-pin').value});
        document.getElementById('user-login').innerHTML = "<h5 class='text-center py-4'>Yêu cầu đã gửi. Chờ Host duyệt...</h5>";
    }

    socket.on('approved_success', () => {
        document.getElementById('user-login').classList.add('hidden');
        document.getElementById('user-active').classList.remove('hidden');
    });

    socket.on('new_q', d => {
        document.getElementById('review-panel').classList.add('hidden');
        if(role === 'user') {
            document.getElementById('u-info').innerText = `VÒNG ${d.round} - CÂU ${d.idx}/10`;
            document.getElementById('u-q-text').innerText = d.q['Câu hỏi'];
            const box = document.getElementById('u-ans-box');
            box.innerHTML = '';
            ['Đáp án A','Đáp án B','Đáp án C','Đáp án D'].forEach(k => {
                const b = document.createElement('button');
                b.className = "btn-ans"; b.innerText = d.q[k];
                b.onclick = () => { socket.emit('submit', {ans: d.q[k]}); box.querySelectorAll('button').forEach(el=>el.disabled=true); b.style.borderColor="var(--navy)"; };
                box.appendChild(b);
            });
        } else {
            document.getElementById('host-monitor').innerHTML = `<div class='text-primary fw-bold'>CÂU ${d.idx}: ${d.q['Câu hỏi']}</div>`;
        }

        let s = 15.0;
        clearInterval(qTimer);
        qTimer = setInterval(() => {
            s -= 0.1;
            const bar = document.getElementById(role === 'user' ? 'u-t-bar' : 'host-monitor'); // Trick to update something on host too
            document.getElementById('u-t-bar').style.width = (s/15)*100 + "%";
            if(s <= 0) clearInterval(qTimer);
        }, 100);
    });

    socket.on('lb_update', d => {
        const html = d.map((p,i) => `<div class='d-flex justify-content-between border-bottom py-1'><span>${i+1}. ${p.name}</span><b>${p.score}đ</b></div>`).join('');
        document.getElementById('h-lb').innerHTML = html;
        document.getElementById('u-lb').innerHTML = html;
    });

    socket.on('event_msg', d => {
        const t = document.createElement('div');
        t.className = "alert alert-warning shadow-sm py-2 px-4 mb-2"; t.innerText = d.msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    });

    socket.on('round_finished', () => {
        if(role === 'host') {
            if(confirm("Kết thúc 10 câu. Bạn muốn tiếp tục Vòng tiếp theo không?")) socket.emit('start_round');
        }
        socket.emit('get_review');
    });

    socket.on('show_review', data => {
        document.getElementById('user-active').classList.add('hidden');
        document.getElementById('review-panel').classList.remove('hidden');
        document.getElementById('review-data').innerHTML = data.map((it,i) => `
            <div class="mb-3 p-3 bg-light border-start border-4 border-primary text-start">
                <p class="mb-1 fw-bold">${i+1}. ${it.q}</p>
                <div class="small">Bạn chọn: <span class="${it.u==it.c?'text-success':'text-danger fw-bold'}">${it.u}</span> | Đáp án đúng: <b class="text-success">${it.c}</b></div>
                <div class="mt-1 small text-muted"><i>Giải thích: ${it.ex}</i></div>
            </div>
        `).join('');
    });
</script>
</body>
</html>
