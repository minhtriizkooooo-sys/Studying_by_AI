<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI QUIZ MARIE CURIE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --navy: #001f3f; --orange: #FF4500; --gold: #FFD700; }
        body { background: #f4f6f9; min-height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; }
        
        /* Header m·ªõi: Logo b√™n tr√°i, Ch·ªØ ·ªü gi·ªØa */
        header { 
            background: var(--navy); 
            color: white; 
            padding: 8px 15px; 
            display: grid; 
            grid-template-columns: 1fr auto 1fr; 
            align-items: center; 
            position: relative;
        }
        .header-logo img { height: 35px; width: auto; }
        .header-title { text-align: center; font-weight: 700; font-size: 1.1rem; letter-spacing: 1px; }
        .header-right { text-align: right; }

        .sub-header { background: #fff; color: var(--navy); text-align: center; padding: 6px; font-weight: bold; border-bottom: 3px solid var(--gold); font-size: 0.85rem; }

        /* Footer ƒê·ªè Cam kh√¥ng vi·ªÅn */
        footer { background: var(--navy); color: white; padding: 15px; text-align: center; margin-top: auto; border: none; }
        .ft-orange { color: var(--orange); font-weight: bold; }

        .main-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); padding: 1.5rem; margin-bottom: 20px; }
        .timer-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .timer-bar { height: 100%; background: linear-gradient(to right, #28a745, #dc3545); width: 100%; transition: width 0.1s linear; }
        
        .btn-ans { border: 2px solid #e9ecef; background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 8px; width: 100%; text-align: left; font-weight: 500; transition: 0.2s; }
        .btn-ans:hover:not(:disabled) { border-color: var(--navy); background: #f0f7ff; }
        .hidden { display: none !important; }

        .wait-box { border: 1px solid #ddd; border-radius: 8px; max-height: 180px; overflow-y: auto; padding: 10px; background: #fafafa; }
        .p-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #eee; }
        
        /* B·∫£ng m·∫´u Template */
        .tmpl-table { font-size: 10px; width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .tmpl-table th, .tmpl-table td { border: 1px solid #dee2e6; padding: 4px; text-align: center; }
        .tmpl-table th { background: #f8f9fa; }
    </style>
</head>
<body>

<header>
    <div class="header-logo">
        <img src="/static/images/Logo_Marie_Curie.png" alt="Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/826/826070.png'">
    </div>
    <div class="header-title">MARIE CURIE EDUCATION</div>
    <div class="header-right">
        
    </div>
</header>
<div class="sub-header">H·ªÜ TH·ªêNG TR·∫ÆC NGHI·ªÜM AI - MARIE CURIE</div>

<div id="toast-container" style="position:fixed; top:90px; left:50%; transform:translateX(-50%); z-index:9999; width: 350px;"></div>

<main class="container my-4">
    <div id="start-screen" class="text-center py-5">
        <div class="main-card d-inline-block p-5">
            <h4 class="mb-4">Ch√†o m·ª´ng b·∫°n</h4>
            <button class="btn btn-dark btn-lg px-4 mx-2" onclick="initHost()">GI√ÅO VI√äN</button>
            <button class="btn btn-outline-dark btn-lg px-4 mx-2" onclick="initUser()">TH√ç SINH</button>
        </div>
    </div>

    <div id="host-panel" class="hidden">
        <div class="row">
            <div class="col-md-5">
                <div class="main-card">
                    <h6 class="fw-bold text-primary">1. T·∫£i B·ªô C√¢u H·ªèi</h6>
                    <table class="tmpl-table">
                        <tr><th>C√¢u h·ªèi</th><th>A->D</th><th>ƒê√∫ng</th><th>Gi·∫£i th√≠ch</th></tr>
                        <tr><td>...</td><td>...</td><td>A/B/C/D</td><td>...</td></tr>
                    </table>
                    <input type="file" id="file-in" class="form-control mb-3">
                    
                    <div id="qr-display" class="hidden text-center p-3 border rounded bg-light">
                        <img id="qr-img" style="width:140px;">
                        <h2 class="fw-bold text-primary mt-2" id="pin-txt">------</h2>
                        <small class="text-muted">Qu√©t m√£ ƒë·ªÉ tham gia ph√≤ng thi</small>
                    </div>
                </div>

                <div class="main-card">
                    <h6 class="fw-bold">2. Ch·ªù Duy·ªát Th√≠ Sinh</h6>
                    <button class="btn btn-sm btn-success w-100 mb-2 hidden" id="btn-app-all" onclick="socket.emit('approve_all')">Duy·ªát t·∫•t c·∫£</button>
                    <div id="wait-list" class="wait-box text-muted small">ƒêang ch·ªù t·∫£i file...</div>
                </div>
                
                <button class="btn btn-danger btn-lg w-100 hidden" id="btn-start" onclick="socket.emit('start_round')">B·∫ÆT ƒê·∫¶U V√íNG THI</button>
            </div>
            
            <div class="col-md-7">
                <div class="main-card">
                    <h6 class="text-center border-bottom pb-2">THEO D√ïI TR·ª∞C TI·∫æP</h6>
                    <div id="host-monitor" class="py-5 text-center h5 text-secondary">Vui l√≤ng m·ªü ph√≤ng thi.</div>
                    <hr>
                    <h6 class="fw-bold">üèÜ B·∫¢NG X·∫æP H·∫†NG</h6>
                    <div id="h-lb"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-panel" class="hidden">
        <div id="user-join" class="main-card mx-auto" style="max-width: 400px;">
            <h5 class="text-center mb-4">V√†o Ph√≤ng Thi</h5>
            <input type="text" id="u-name" class="form-control mb-2" placeholder="T√™n c·ªßa b·∫°n">
            <input type="text" id="u-pin" class="form-control mb-3" placeholder="M√£ PIN 6 s·ªë">
            <button class="btn btn-primary w-100 fw-bold" onclick="joinRoom()">G·ª¨I Y√äU C·∫¶U</button>
        </div>
        
        <div id="user-active" class="hidden">
            <div class="main-card text-center">
                <div id="u-info" class="small text-muted mb-2"></div>
                <h4 id="u-q-text" class="fw-bold my-4">Ch·ªù gi√°o vi√™n b·∫Øt ƒë·∫ßu...</h4>
                <div class="timer-bg"><div id="u-t-bar" class="timer-bar"></div></div>
                <div id="u-ans-box" class="mt-4"></div>
            </div>
            <div class="main-card">
                <h6>X·∫æP H·∫†NG C·ª¶A B·∫†N</h6>
                <div id="u-lb"></div>
            </div>
        </div>
    </div>

    <div id="review-panel" class="hidden main-card">
        <h4 class="text-primary border-bottom pb-3">K·∫æT QU·∫¢ & GI·∫¢I TH√çCH</h4>
        <div id="review-data"></div>
        <button class="btn btn-dark w-100 mt-3" onclick="location.reload()">K·∫æT TH√öC</button>
    </div>
</main>

<footer>
    Developer: <span class="ft-orange">L·∫°i Nguy·ªÖn Minh Tr√≠</span> | Hotline: <span class="ft-orange">84-908-08-3566</span><br>
    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">H·ªá th·ªëng Tr·∫Øc nghi·ªám Th√¥ng minh ¬© 2026</div>
</footer>

<script>
    const socket = io();
    let myRole = "";
    let qTimer;

    function initHost() { myRole="host"; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('host-panel').classList.remove('hidden'); }
    function initUser() { myRole="user"; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('user-panel').classList.remove('hidden'); }

    document.getElementById('file-in').onchange = e => {
        const r = new FileReader();
        r.onload = () => socket.emit('host_upload_file', {content: r.result});
        r.readAsDataURL(e.target.files[0]);
    };

    socket.on('qr_ready', d => {
        document.getElementById('qr-display').classList.remove('hidden');
        document.getElementById('qr-img').src = "data:image/png;base64," + d.qr;
        document.getElementById('pin-txt').innerText = d.pin;
        document.getElementById('btn-start').classList.remove('hidden');
        document.getElementById('btn-app-all').classList.remove('hidden');
        document.getElementById('wait-list').innerHTML = ""; 
    });

    socket.on('new_player_waiting', d => {
        const div = document.createElement('div');
        div.className = "p-row";
        div.innerHTML = `<span><b>${d.name}</b></span> <button class="btn btn-sm btn-primary py-0" style="font-size:11px" onclick="socket.emit('approve_player', {sid:'${d.sid}'})">Duy·ªát</button>`;
        document.getElementById('wait-list').appendChild(div);
    });

    function joinRoom() {
        const n = document.getElementById('u-name').value;
        const p = document.getElementById('u-pin').value;
        if(!n || !p) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        socket.emit('join_request', {name: n, pin: p});
        document.getElementById('user-join').innerHTML = `<div class='text-center py-4'><div class='spinner-border text-primary mb-3'></div><h5>ƒê√£ g·ª≠i y√™u c·∫ßu...</h5><p class='text-muted small'>Vui l√≤ng ch·ªù ƒë∆∞·ª£c duy·ªát v√†o ph√≤ng.</p></div>`;
    }

    socket.on('approved_success', () => {
        document.getElementById('user-join').classList.add('hidden');
        document.getElementById('user-active').classList.remove('hidden');
    });

    socket.on('new_q', d => {
        document.getElementById('review-panel').classList.add('hidden');
        if(myRole === 'user') {
            document.getElementById('u-info').innerText = `V√íNG ${d.round} - C√ÇU ${d.idx}/10`;
            document.getElementById('u-q-text').innerText = d.q['C√¢u h·ªèi'];
            const box = document.getElementById('u-ans-box');
            box.innerHTML = '';
            ['ƒê√°p √°n A','ƒê√°p √°n B','ƒê√°p √°n C','ƒê√°p √°n D'].forEach(k => {
                const b = document.createElement('button');
                b.className = "btn-ans"; b.innerText = d.q[k];
                b.onclick = () => { socket.emit('submit', {ans: d.q[k]}); box.querySelectorAll('button').forEach(el=>el.disabled=true); b.style.borderColor="var(--navy)"; };
                box.appendChild(b);
            });
        } else {
            document.getElementById('host-monitor').innerHTML = `<div class='p-3'><span class='badge bg-primary mb-2'>C√ÇU ${d.idx}</span><h4 class='fw-bold'>${d.q['C√¢u h·ªèi']}</h4></div>`;
        }

        let s = 15.5;
        clearInterval(qTimer);
        qTimer = setInterval(() => {
            s -= 0.1;
            if(document.getElementById('u-t-bar')) document.getElementById('u-t-bar').style.width = (s/15.5)*100 + "%";
            if(s <= 0) clearInterval(qTimer);
        }, 100);
    });

    socket.on('lb_update', d => {
        const h = d.map((p,i) => `<div class='d-flex justify-content-between border-bottom py-2'><span><b>${i+1}.</b> ${p.name}</span><span class='badge bg-light text-dark'>${p.score}ƒë</span></div>`).join('');
        document.getElementById('h-lb').innerHTML = h;
        document.getElementById('u-lb').innerHTML = h;
    });

    socket.on('event_msg', d => {
        const t = document.createElement('div');
        t.className = "alert alert-warning shadow-sm py-2 px-3 mb-2"; t.innerHTML = `<small>${d.msg}</small>`;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    });

    socket.on('round_finished', () => {
        if(myRole === 'host') if(confirm("K·∫øt th√∫c v√≤ng thi n√†y. B·∫°n mu·ªën ti·∫øp t·ª•c v√≤ng sau?")) socket.emit('start_round');
        socket.emit('get_review');
    });

    socket.on('show_review', data => {
        document.getElementById('user-active').classList.add('hidden');
        document.getElementById('review-panel').classList.remove('hidden');
        document.getElementById('review-data').innerHTML = data.map((it,i) => `
            <div class="mb-3 p-3 bg-light border-start border-4 border-primary">
                <p class="mb-1 fw-bold">${i+1}. ${it.q}</p>
                <div class="small mb-1">B·∫°n ch·ªçn: <span class="${it.u==it.c?'text-success fw-bold':'text-danger fw-bold'}">${it.u}</span> | ƒê√∫ng: <b class="text-success">${it.c}</b></div>
                <div class="bg-white p-2 rounded border x-small text-muted"><b>Gi·∫£i th√≠ch:</b> ${it.ex}</div>
            </div>
        `).join('');
    });
</script>
</body>
</html>
