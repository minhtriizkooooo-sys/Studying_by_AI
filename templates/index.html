<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIE CURIE QUIZ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bordeaux-orange: #FF4500; --navy: #001f3f; --gold: #FFD700; }
        body { background: #f8f9fa; min-height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; }
        
        /* Header nhỏ gọn */
        header { background: var(--navy); color: white; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sub-header { background: #e9ecef; color: var(--navy); text-align: center; padding: 5px; font-weight: bold; border-bottom: 2px solid var(--gold); }

        /* Footer Đỏ Cam không viền */
        footer { background: var(--navy); color: white; padding: 15px; text-align: center; margin-top: auto; }
        .ft-red { color: var(--bordeaux-orange); font-weight: bold; }

        .main-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 1.5rem; margin-bottom: 20px; }
        .timer-bg { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .timer-bar { height: 100%; background: linear-gradient(to right, #28a745, #dc3545); width: 100%; transition: width 0.1s linear; }
        
        .btn-ans { border: 2px solid #dee2e6; background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; width: 100%; text-align: left; font-weight: 500; }
        .btn-ans:hover:not(:disabled) { border-color: var(--navy); background: #f0f7ff; }
        .hidden { display: none !important; }
        .wait-item { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        
        #lb-box div { padding: 8px; border-bottom: 1px solid #f1f1f1; display: flex; justify-content: space-between; }
        .toast-msg { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; }
    </style>
</head>
<body>

<header class="d-flex justify-content-between align-items-center">
    <h5 class="m-0 fw-bold">MARIE CURIE EDUCATION</h5>
    <div class="badge bg-primary">Online</div>
</header>
<div class="sub-header">
    HỆ THỐNG TRẮC NGHIỆM AI - MARIE CURIE
</div>

<div id="toast-container" class="toast-msg"></div>

<main class="container my-4">
    <div id="start-screen" class="text-center py-5">
        <div class="main-card d-inline-block p-5">
            <h3 class="mb-4">Chào mừng bạn đến với Hệ thông trắc nghiệm AI</h3>
            <button class="btn btn-dark btn-lg px-4 mx-2" onclick="openHost()">GIÁO VIÊN</button>
            <button class="btn btn-outline-dark btn-lg px-4 mx-2" onclick="openUser()">THÍ SINH</button>
        </div>
    </div>

    <div id="host-panel" class="hidden">
        <div class="row">
            <div class="col-md-4">
                <div class="main-card">
                    <h6>1. TẢI BỘ ĐỀ</h6>
                    <input type="file" id="file-in" class="form-control mb-3">
                    <div id="qr-box" class="hidden text-center">
                        <img id="qr-img" style="width:150px">
                        <h3 class="text-primary mt-2" id="pin-val"></h3>
                    </div>
                </div>
                <div class="main-card">
                    <h6>2. DUYỆT THÍ SINH</h6>
                    <button class="btn btn-sm btn-success w-100 mb-2 hidden" id="btn-all" onclick="socket.emit('approve_all')">Duyệt tất cả</button>
                    <div id="wait-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <button class="btn btn-danger w-100 mb-2 hidden" id="btn-go" onclick="socket.emit('start_round')">BẮT ĐẦU THI</button>
                <button class="btn btn-outline-danger w-100" onclick="location.reload()">KẾT THÚC THI</button>
            </div>
            <div class="col-md-8">
                <div class="main-card">
                    <h5 class="text-center">MÀN HÌNH GIÁM SÁT</h5>
                    <div id="host-q-view" class="py-3"></div>
                    <hr>
                    <h6>XẾP HẠNG TRỰC TUYẾN</h6>
                    <div id="h-lb"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-panel" class="hidden">
        <div id="user-join" class="main-card mx-auto" style="max-width: 400px;">
            <input type="text" id="u-name" class="form-control mb-2" placeholder="Họ tên">
            <input type="text" id="u-pin" class="form-control mb-3" placeholder="Mã PIN">
            <button class="btn btn-primary w-100" onclick="sendJoin()">VÀO PHÒNG</button>
        </div>
        <div id="user-game" class="hidden">
            <div class="main-card text-center">
                <div id="q-info" class="text-muted small"></div>
                <h4 id="q-text" class="fw-bold my-4">Đợi câu hỏi...</h4>
                <div class="timer-bg mb-4"><div id="t-bar" class="timer-bar"></div></div>
                <div id="ans-box"></div>
            </div>
            <div class="main-card">
                <h6>XẾP HẠNG</h6>
                <div id="u-lb"></div>
            </div>
        </div>
    </div>

    <div id="review-panel" class="hidden main-card">
        <h4 class="text-primary border-bottom pb-2">REVIEW KẾT QUẢ & GIẢI THÍCH</h4>
        <div id="review-data"></div>
        <button class="btn btn-dark mt-3" onclick="location.reload()">Quay lại</button>
    </div>
</main>

<footer>
    Developer: <span class="ft-red">Lại Nguyễn Minh Trí</span> | Hotline: <span class="ft-red">84-908-08-3566</span><br>
    <small style="opacity:0.8">Hệ thống Trắc nghiệm Thông minh © 2026</small>
</footer>

<script>
    const socket = io();
    let myRole = "";
    let timer;

    function openHost() { myRole="host"; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('host-panel').classList.remove('hidden'); }
    function openUser() { myRole="user"; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('user-panel').classList.remove('hidden'); }

    document.getElementById('file-in').onchange = e => {
        const r = new FileReader();
        r.onload = () => socket.emit('host_upload_file', {content: r.result});
        r.readAsDataURL(e.target.files[0]);
    };

    socket.on('qr_ready', d => {
        document.getElementById('qr-box').classList.remove('hidden');
        document.getElementById('qr-img').src = "data:image/png;base64," + d.qr;
        document.getElementById('pin-val').innerText = d.pin;
        document.getElementById('btn-go').classList.remove('hidden');
        document.getElementById('btn-all').classList.remove('hidden');
    });

    socket.on('new_player_waiting', d => {
        const div = document.createElement('div');
        div.className = "wait-item";
        div.id = "wait-" + d.sid;
        div.innerHTML = `<span>${d.name}</span> <button class="btn btn-xs btn-primary py-0" onclick="socket.emit('approve_player', {sid:'${d.sid}'})">Duyệt</button>`;
        document.getElementById('wait-list').appendChild(div);
    });

    function sendJoin() {
        socket.emit('join_request', {name: document.getElementById('u-name').value, pin: document.getElementById('u-pin').value});
        document.getElementById('user-join').innerHTML = "<h5 class='text-center'>Đang chờ giáo viên duyệt...</h5>";
    }

    socket.on('approved_success', () => {
        document.getElementById('user-join').classList.add('hidden');
        document.getElementById('user-game').classList.remove('hidden');
    });

    socket.on('new_q', d => {
        document.getElementById('review-panel').classList.add('hidden');
        if(myRole === 'user') {
            document.getElementById('q-info').innerText = `VÒNG ${d.round} - CÂU ${d.idx}/10`;
            document.getElementById('q-text').innerText = d.q['Câu hỏi'];
            const box = document.getElementById('ans-box');
            box.innerHTML = '';
            ['Đáp án A','Đáp án B','Đáp án C','Đáp án D'].forEach(k => {
                const b = document.createElement('button');
                b.className = "btn-ans"; b.innerText = d.q[k];
                b.onclick = () => { socket.emit('submit', {ans: d.q[k]}); box.querySelectorAll('button').forEach(x=>x.disabled=true); b.style.borderColor="var(--navy)"; };
                box.appendChild(b);
            });
        } else {
            document.getElementById('host-q-view').innerHTML = `<h6>CÂU ${d.idx}: ${d.q['Câu hỏi']}</h6>`;
        }

        let s = 15.0;
        clearInterval(timer);
        timer = setInterval(() => {
            s -= 0.1;
            document.getElementById('t-bar').style.width = (s/15)*100 + "%";
            if(s <= 0) clearInterval(timer);
        }, 100);
    });

    socket.on('lb_update', d => {
        const h = d.map((p,i) => `<div><span>${i+1}. ${p.name}</span><b>${p.score}đ</b></div>`).join('');
        document.getElementById('h-lb').innerHTML = h;
        document.getElementById('u-lb').innerHTML = h;
    });

    socket.on('event_msg', d => {
        const t = document.createElement('div');
        t.className = "alert alert-warning shadow-sm"; t.innerText = d.msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    });

    socket.on('round_finished', () => {
        if(myRole === 'host') {
            if(confirm("Kết thúc vòng thi! Bạn có muốn tiếp tục vòng tiếp theo không?")) socket.emit('start_round');
        }
        socket.emit('get_review');
    });

    socket.on('show_review', data => {
        document.getElementById('user-game').classList.add('hidden');
        document.getElementById('review-panel').classList.remove('hidden');
        document.getElementById('review-data').innerHTML = data.map((it,i) => `
            <div class="mb-3 p-3 bg-light border-start border-4 border-primary">
                <p class="mb-1 fw-bold">${i+1}. ${it.q}</p>
                <div class="small">Chọn: <span class="${it.u==it.c?'text-success':'text-danger'}">${it.u}</span> | Đúng: <b class="text-success">${it.c}</b></div>
                <div class="mt-1 x-small text-muted italic"><b>Giải thích:</b> ${it.ex}</div>
            </div>
        `).join('');
    });
</script>
</body>
</html>
